import{Cartesian3,Check,defined,destroyObject,HeadingPitchRoll,Matrix3,Matrix4,CustomShader,VoxelShapeType}from"@cesium/engine";import knockout from"../ThirdParty/knockout.js";function formatShaderString(i){const n=i.split("\n");let e;for(e=0;e<n.length&&!n[e].match(/\S/);e++);if(e===n.length)return"";let t="";const o=/^\s*/,l=n[e].match(o)[0].length;for(let i=e;i<n.length;i++){let e=n[i];e.match(o)[0].length>=l&&(e=e.slice(l)),t+=`${e}\n`}return t}function VoxelInspectorViewModel(i){Check.typeOf.object("scene",i),this._scene=i,this._voxelPrimitive=void 0,this._customShaderCompilationRemoveCallback=void 0,this._definedProperties=[],this._getPrimitiveFunctions=[],this._modelMatrixReady=!1;const n=this;function e(e){const{name:t,initialValue:o}=e;n._definedProperties.push(t);let l=e.setPrimitiveFunction;!0===l&&(l=function(i){n._voxelPrimitive[t]=i});let a=e.getPrimitiveFunction;!0===a&&(a=function(){n[t]=n._voxelPrimitive[t]}),defined(a)&&n._getPrimitiveFunctions.push(a);const s=knockout.observable();return knockout.defineProperty(n,t,{get:function(){return s()},set:function(e){"number"==typeof o&&"string"==typeof e&&(e=Number(e),isNaN(e)&&(e=o)),"boolean"==typeof o&&"number"==typeof e&&(e=1===e),s(e),defined(l)&&defined(n._voxelPrimitive)&&(l(e),i.requestRender())}}),n[t]=o,s}function t(i,e){return function(t){const o=n._voxelPrimitive[i].clone();o[e]=t,n._voxelPrimitive[i]=o}}e({name:"inspectorVisible",initialValue:!0}),e({name:"displayVisible",initialValue:!1}),e({name:"transformVisible",initialValue:!1}),e({name:"boundsVisible",initialValue:!1}),e({name:"clippingVisible",initialValue:!1}),e({name:"shaderVisible",initialValue:!1}),e({name:"shaderString",initialValue:"",getPrimitiveFunction:function(){const i=n._voxelPrimitive.customShader.fragmentShaderText;n.shaderString=formatShaderString(i)}}),e({name:"shaderCompilationMessage",initialValue:""}),e({name:"shaderCompilationSuccess",initialValue:!0}),e({name:"depthTest",initialValue:!1,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"show",initialValue:!0,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"disableUpdate",initialValue:!1,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"debugDraw",initialValue:!1,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"jitter",initialValue:!0,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"nearestSampling",initialValue:!0,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"screenSpaceError",initialValue:4,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"stepSize",initialValue:1,setPrimitiveFunction:!0,getPrimitiveFunction:!0}),e({name:"shapeIsBox",getPrimitiveFunction:function(){const i=n._voxelPrimitive.shape;n.shapeIsBox=i===VoxelShapeType.BOX}}),e({name:"shapeIsEllipsoid",getPrimitiveFunction:function(){const i=n._voxelPrimitive.shape;n.shapeIsEllipsoid=i===VoxelShapeType.ELLIPSOID}}),e({name:"shapeIsCylinder",getPrimitiveFunction:function(){const i=n._voxelPrimitive.shape;n.shapeIsCylinder=i===VoxelShapeType.CYLINDER}}),e({name:"boundsBoxMaxX",initialValue:0,setPrimitiveFunction:t("maxBounds","x"),getPrimitiveFunction:function(){n.boundsBoxMaxX=n._voxelPrimitive.maxBounds.x}}),e({name:"boundsBoxMinX",initialValue:0,setPrimitiveFunction:t("minBounds","x"),getPrimitiveFunction:function(){n.boundsBoxMinX=n._voxelPrimitive.minBounds.x}}),e({name:"boundsBoxMaxY",initialValue:0,setPrimitiveFunction:t("maxBounds","y"),getPrimitiveFunction:function(){n.boundsBoxMaxY=n._voxelPrimitive.maxBounds.y}}),e({name:"boundsBoxMinY",initialValue:0,setPrimitiveFunction:t("minBounds","y"),getPrimitiveFunction:function(){n.boundsBoxMinY=n._voxelPrimitive.minBounds.y}}),e({name:"boundsBoxMaxZ",initialValue:0,setPrimitiveFunction:t("maxBounds","z"),getPrimitiveFunction:function(){n.boundsBoxMaxZ=n._voxelPrimitive.maxBounds.z}}),e({name:"boundsBoxMinZ",initialValue:0,setPrimitiveFunction:t("minBounds","z"),getPrimitiveFunction:function(){n.boundsBoxMinZ=n._voxelPrimitive.minBounds.z}}),e({name:"boundsEllipsoidMaxLongitude",initialValue:0,setPrimitiveFunction:t("maxBounds","x"),getPrimitiveFunction:function(){n.boundsEllipsoidMaxLongitude=n._voxelPrimitive.maxBounds.x}}),e({name:"boundsEllipsoidMinLongitude",initialValue:0,setPrimitiveFunction:t("minBounds","x"),getPrimitiveFunction:function(){n.boundsEllipsoidMinLongitude=n._voxelPrimitive.minBounds.x}}),e({name:"boundsEllipsoidMaxLatitude",initialValue:0,setPrimitiveFunction:t("maxBounds","y"),getPrimitiveFunction:function(){n.boundsEllipsoidMaxLatitude=n._voxelPrimitive.maxBounds.y}}),e({name:"boundsEllipsoidMinLatitude",initialValue:0,setPrimitiveFunction:t("minBounds","y"),getPrimitiveFunction:function(){n.boundsEllipsoidMinLatitude=n._voxelPrimitive.minBounds.y}}),e({name:"boundsEllipsoidMaxHeight",initialValue:0,setPrimitiveFunction:t("maxBounds","z"),getPrimitiveFunction:function(){n.boundsEllipsoidMaxHeight=n._voxelPrimitive.maxBounds.z}}),e({name:"boundsEllipsoidMinHeight",initialValue:0,setPrimitiveFunction:t("minBounds","z"),getPrimitiveFunction:function(){n.boundsEllipsoidMinHeight=n._voxelPrimitive.minBounds.z}}),e({name:"boundsCylinderMaxRadius",initialValue:0,setPrimitiveFunction:t("maxBounds","x"),getPrimitiveFunction:function(){n.boundsCylinderMaxRadius=n._voxelPrimitive.maxBounds.x}}),e({name:"boundsCylinderMinRadius",initialValue:0,setPrimitiveFunction:t("minBounds","x"),getPrimitiveFunction:function(){n.boundsCylinderMinRadius=n._voxelPrimitive.minBounds.x}}),e({name:"boundsCylinderMaxHeight",initialValue:0,setPrimitiveFunction:t("maxBounds","y"),getPrimitiveFunction:function(){n.boundsCylinderMaxHeight=n._voxelPrimitive.maxBounds.y}}),e({name:"boundsCylinderMinHeight",initialValue:0,setPrimitiveFunction:t("minBounds","y"),getPrimitiveFunction:function(){n.boundsCylinderMinHeight=n._voxelPrimitive.minBounds.y}}),e({name:"boundsCylinderMaxAngle",initialValue:0,setPrimitiveFunction:t("maxBounds","z"),getPrimitiveFunction:function(){n.boundsCylinderMaxAngle=n._voxelPrimitive.maxBounds.z}}),e({name:"boundsCylinderMinAngle",initialValue:0,setPrimitiveFunction:t("minBounds","z"),getPrimitiveFunction:function(){n.boundsCylinderMinAngle=n._voxelPrimitive.minBounds.z}}),e({name:"clippingBoxMaxX",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","x"),getPrimitiveFunction:function(){n.clippingBoxMaxX=n._voxelPrimitive.maxClippingBounds.x}}),e({name:"clippingBoxMinX",initialValue:0,setPrimitiveFunction:t("minClippingBounds","x"),getPrimitiveFunction:function(){n.clippingBoxMinX=n._voxelPrimitive.minClippingBounds.x}}),e({name:"clippingBoxMaxY",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","y"),getPrimitiveFunction:function(){n.clippingBoxMaxY=n._voxelPrimitive.maxClippingBounds.y}}),e({name:"clippingBoxMinY",initialValue:0,setPrimitiveFunction:t("minClippingBounds","y"),getPrimitiveFunction:function(){n.clippingBoxMinY=n._voxelPrimitive.minClippingBounds.y}}),e({name:"clippingBoxMaxZ",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","z"),getPrimitiveFunction:function(){n.clippingBoxMaxZ=n._voxelPrimitive.maxClippingBounds.z}}),e({name:"clippingBoxMinZ",initialValue:0,setPrimitiveFunction:t("minClippingBounds","z"),getPrimitiveFunction:function(){n.clippingBoxMinZ=n._voxelPrimitive.minClippingBounds.z}}),e({name:"clippingEllipsoidMaxLongitude",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","x"),getPrimitiveFunction:function(){n.clippingEllipsoidMaxLongitude=n._voxelPrimitive.maxClippingBounds.x}}),e({name:"clippingEllipsoidMinLongitude",initialValue:0,setPrimitiveFunction:t("minClippingBounds","x"),getPrimitiveFunction:function(){n.clippingEllipsoidMinLongitude=n._voxelPrimitive.minClippingBounds.x}}),e({name:"clippingEllipsoidMaxLatitude",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","y"),getPrimitiveFunction:function(){n.clippingEllipsoidMaxLatitude=n._voxelPrimitive.maxClippingBounds.y}}),e({name:"clippingEllipsoidMinLatitude",initialValue:0,setPrimitiveFunction:t("minClippingBounds","y"),getPrimitiveFunction:function(){n.clippingEllipsoidMinLatitude=n._voxelPrimitive.minClippingBounds.y}}),e({name:"clippingEllipsoidMaxHeight",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","z"),getPrimitiveFunction:function(){n.clippingEllipsoidMaxHeight=n._voxelPrimitive.maxClippingBounds.z}}),e({name:"clippingEllipsoidMinHeight",initialValue:0,setPrimitiveFunction:t("minClippingBounds","z"),getPrimitiveFunction:function(){n.clippingEllipsoidMinHeight=n._voxelPrimitive.minClippingBounds.z}}),e({name:"clippingCylinderMaxRadius",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","x"),getPrimitiveFunction:function(){n.clippingCylinderMaxRadius=n._voxelPrimitive.maxClippingBounds.x}}),e({name:"clippingCylinderMinRadius",initialValue:0,setPrimitiveFunction:t("minClippingBounds","x"),getPrimitiveFunction:function(){n.clippingCylinderMinRadius=n._voxelPrimitive.minClippingBounds.x}}),e({name:"clippingCylinderMaxHeight",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","y"),getPrimitiveFunction:function(){n.clippingCylinderMaxHeight=n._voxelPrimitive.maxClippingBounds.y}}),e({name:"clippingCylinderMinHeight",initialValue:0,setPrimitiveFunction:t("minClippingBounds","y"),getPrimitiveFunction:function(){n.clippingCylinderMinHeight=n._voxelPrimitive.minClippingBounds.y}}),e({name:"clippingCylinderMaxAngle",initialValue:0,setPrimitiveFunction:t("maxClippingBounds","z"),getPrimitiveFunction:function(){n.clippingCylinderMaxAngle=n._voxelPrimitive.maxClippingBounds.z}}),e({name:"clippingCylinderMinAngle",initialValue:0,setPrimitiveFunction:t("minClippingBounds","z"),getPrimitiveFunction:function(){n.clippingCylinderMinAngle=n._voxelPrimitive.minClippingBounds.z}}),e({name:"translationX",initialValue:0,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)},getPrimitiveFunction:function(){n.translationX=Matrix4.getTranslation(n._voxelPrimitive.modelMatrix,new Cartesian3).x}}),e({name:"translationY",initialValue:0,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)},getPrimitiveFunction:function(){n.translationY=Matrix4.getTranslation(n._voxelPrimitive.modelMatrix,new Cartesian3).y}}),e({name:"translationZ",initialValue:0,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)},getPrimitiveFunction:function(){n.translationZ=Matrix4.getTranslation(n._voxelPrimitive.modelMatrix,new Cartesian3).z}}),e({name:"scaleX",initialValue:1,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)},getPrimitiveFunction:function(){n.scaleX=Matrix4.getScale(n._voxelPrimitive.modelMatrix,new Cartesian3).x}}),e({name:"scaleY",initialValue:1,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)},getPrimitiveFunction:function(){n.scaleY=Matrix4.getScale(n._voxelPrimitive.modelMatrix,new Cartesian3).y}}),e({name:"scaleZ",initialValue:1,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)},getPrimitiveFunction:function(){n.scaleZ=Matrix4.getScale(n._voxelPrimitive.modelMatrix,new Cartesian3).z}}),e({name:"angleX",initialValue:0,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)}}),e({name:"angleY",initialValue:0,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)}}),e({name:"angleZ",initialValue:0,setPrimitiveFunction:function(){n._modelMatrixReady&&setModelMatrix(n)}})}const scratchTranslation=new Cartesian3,scratchScale=new Cartesian3,scratchHeadingPitchRoll=new HeadingPitchRoll,scratchRotation=new Matrix3;function setModelMatrix(i){const n=Cartesian3.fromElements(i.translationX,i.translationY,i.translationZ,scratchTranslation),e=Cartesian3.fromElements(i.scaleX,i.scaleY,i.scaleZ,scratchScale),t=scratchHeadingPitchRoll;t.heading=i.angleX,t.pitch=i.angleY,t.roll=i.angleZ;const o=Matrix3.fromHeadingPitchRoll(t,scratchRotation),l=Matrix3.multiplyByScale(o,e,o);i._voxelPrimitive.modelMatrix=Matrix4.fromRotationTranslation(l,n,i._voxelPrimitive.modelMatrix)}Object.defineProperties(VoxelInspectorViewModel.prototype,{scene:{get:function(){return this._scene}},voxelPrimitive:{get:function(){return this._voxelPrimitive},set:function(i){if(defined(this._customShaderCompilationRemoveCallback)&&this._customShaderCompilationRemoveCallback(),defined(i)){this._voxelPrimitive=i;const n=this;n._customShaderCompilationRemoveCallback=n._voxelPrimitive.customShaderCompilationEvent.addEventListener((function(i){const e=n._voxelPrimitive.customShader.fragmentShaderText;n.shaderString=formatShaderString(e),defined(i)?(n.shaderCompilationMessage=i.message,n.shaderCompilationSuccess=!1):(n.shaderCompilationMessage="Shader compiled successfully!",n.shaderCompilationSuccess=!0)})),n._modelMatrixReady=!1;for(let i=0;i<n._getPrimitiveFunctions.length;i++)n._getPrimitiveFunctions[i]();n._modelMatrixReady=!0,setModelMatrix(n)}}}}),VoxelInspectorViewModel.prototype.toggleInspector=function(){this.inspectorVisible=!this.inspectorVisible},VoxelInspectorViewModel.prototype.toggleDisplay=function(){this.displayVisible=!this.displayVisible},VoxelInspectorViewModel.prototype.toggleTransform=function(){this.transformVisible=!this.transformVisible},VoxelInspectorViewModel.prototype.toggleBounds=function(){this.boundsVisible=!this.boundsVisible},VoxelInspectorViewModel.prototype.toggleClipping=function(){this.clippingVisible=!this.clippingVisible},VoxelInspectorViewModel.prototype.toggleShader=function(){this.shaderVisible=!this.shaderVisible},VoxelInspectorViewModel.prototype.compileShader=function(){defined(this._voxelPrimitive)&&(this._voxelPrimitive.customShader=new CustomShader({fragmentShaderText:this.shaderString,uniforms:this._voxelPrimitive.customShader.uniforms}))},VoxelInspectorViewModel.prototype.shaderEditorKeyPress=function(i,n){if(9===n.keyCode){n.preventDefault();const i=n.target,e=i.selectionStart,t=i.selectionEnd;let o=t;const l=i.value.slice(e,t).split("\n"),a=l.length;let s;if(n.shiftKey)for(s=0;s<a;++s)" "===l[s][0]&&(" "===l[s][1]?(l[s]=l[s].substr(2),o-=2):(l[s]=l[s].substr(1),o-=1));else for(s=0;s<a;++s)l[s]=`  ${l[s]}`,o+=2;const u=l.join("\n");i.value=i.value.slice(0,e)+u+i.value.slice(t),i.selectionStart=e!==t?e:o,i.selectionEnd=o}else!n.ctrlKey||10!==n.keyCode&&13!==n.keyCode||this.compileShader();return!0},VoxelInspectorViewModel.prototype.isDestroyed=function(){return!1},VoxelInspectorViewModel.prototype.destroy=function(){const i=this;return this._definedProperties.forEach((function(n){knockout.getObservable(i,n).dispose()})),destroyObject(this)};export default VoxelInspectorViewModel;