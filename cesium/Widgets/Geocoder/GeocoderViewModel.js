import{CartographicGeocoderService,computeFlyToLocationForRectangle,defaultValue,defined,DeveloperError,destroyObject,Event,GeocoderService,GeocodeType,getElement,IonGeocoderService,Math as CesiumMath,Matrix4,Rectangle,sampleTerrainMostDetailed}from"@cesium/engine";import knockout from"../ThirdParty/knockout.js";import createCommand from"../createCommand.js";const DEFAULT_HEIGHT=1e3;function GeocoderViewModel(e){if(!defined(e)||!defined(e.scene))throw new DeveloperError("options.scene is required.");defined(e.geocoderServices)?this._geocoderServices=e.geocoderServices:this._geocoderServices=[new CartographicGeocoderService,new IonGeocoderService({scene:e.scene})],this._viewContainer=e.container,this._scene=e.scene,this._flightDuration=e.flightDuration,this._searchText="",this._isSearchInProgress=!1,this._wasGeocodeCancelled=!1,this._previousCredits=[],this._complete=new Event,this._suggestions=[],this._selectedSuggestion=void 0,this._showSuggestions=!0,this._handleArrowDown=handleArrowDown,this._handleArrowUp=handleArrowUp;const t=this;this._suggestionsVisible=knockout.pureComputed((function(){const e=knockout.getObservable(t,"_suggestions")().length>0,o=knockout.getObservable(t,"_showSuggestions")();return e&&o})),this._searchCommand=createCommand((function(e){return e=defaultValue(e,GeocodeType.SEARCH),t._focusTextbox=!1,defined(t._selectedSuggestion)?(t.activateSuggestion(t._selectedSuggestion),!1):(t.hideSuggestions(),t.isSearchInProgress?void cancelGeocode(t):geocode(t,t._geocoderServices,e))})),this.deselectSuggestion=function(){t._selectedSuggestion=void 0},this.handleKeyDown=function(e,t){const o="ArrowDown"===t.key||"Down"===t.key||40===t.keyCode,s="ArrowUp"===t.key||"Up"===t.key||38===t.keyCode;return(o||s)&&t.preventDefault(),!0},this.handleKeyUp=function(e,o){const s="ArrowDown"===o.key||"Down"===o.key||40===o.keyCode,i="ArrowUp"===o.key||"Up"===o.key||38===o.keyCode,n="Enter"===o.key||13===o.keyCode;return i?handleArrowUp(t):s?handleArrowDown(t):n&&t._searchCommand(),!0},this.activateSuggestion=function(e){t.hideSuggestions(),t._searchText=e.displayName;const o=e.destination;clearSuggestions(t),t.destinationFound(t,o)},this.hideSuggestions=function(){t._showSuggestions=!1,t._selectedSuggestion=void 0},this.showSuggestions=function(){t._showSuggestions=!0},this.handleMouseover=function(e,o){e!==t._selectedSuggestion&&(t._selectedSuggestion=e)},this.keepExpanded=!1,this.autoComplete=defaultValue(e.autocomplete,!0),this.destinationFound=defaultValue(e.destinationFound,GeocoderViewModel.flyToDestination),this._focusTextbox=!1,knockout.track(this,["_searchText","_isSearchInProgress","keepExpanded","_suggestions","_selectedSuggestion","_showSuggestions","_focusTextbox"]);const o=knockout.getObservable(this,"_searchText");o.extend({rateLimit:{timeout:500}}),this._suggestionSubscription=o.subscribe((function(){GeocoderViewModel._updateSearchSuggestions(t)})),this.isSearchInProgress=void 0,knockout.defineProperty(this,"isSearchInProgress",{get:function(){return this._isSearchInProgress}}),this.searchText=void 0,knockout.defineProperty(this,"searchText",{get:function(){return this.isSearchInProgress?"Searching...":this._searchText},set:function(e){if("string"!=typeof e)throw new DeveloperError("value must be a valid string.");this._searchText=e}}),this.flightDuration=void 0,knockout.defineProperty(this,"flightDuration",{get:function(){return this._flightDuration},set:function(e){if(defined(e)&&e<0)throw new DeveloperError("value must be positive.");this._flightDuration=e}})}function handleArrowUp(e){if(0===e._suggestions.length)return;const t=e._suggestions.indexOf(e._selectedSuggestion);if(-1===t||0===t)return void(e._selectedSuggestion=void 0);const o=t-1;e._selectedSuggestion=e._suggestions[o],GeocoderViewModel._adjustSuggestionsScroll(e,o)}function handleArrowDown(e){if(0===e._suggestions.length)return;const t=e._suggestions.length,o=(e._suggestions.indexOf(e._selectedSuggestion)+1)%t;e._selectedSuggestion=e._suggestions[o],GeocoderViewModel._adjustSuggestionsScroll(e,o)}function computeFlyToLocationForCartographic(e,t){const o=defined(t)?t.availability:void 0;return defined(o)?sampleTerrainMostDetailed(t,[e]).then((function(t){return(e=t[0]).height+=DEFAULT_HEIGHT,e})):(e.height+=DEFAULT_HEIGHT,Promise.resolve(e))}function flyToDestination(e,t){const o=e._scene,s=o.mapProjection.ellipsoid,i=o.camera,n=o.terrainProvider;let r,c=t;return t instanceof Rectangle?CesiumMath.equalsEpsilon(t.south,t.north,CesiumMath.EPSILON7)&&CesiumMath.equalsEpsilon(t.east,t.west,CesiumMath.EPSILON7)?t=Rectangle.center(t):r=computeFlyToLocationForRectangle(t,o):t=s.cartesianToCartographic(t),defined(r)||(r=computeFlyToLocationForCartographic(t,n)),r.then((function(e){c=s.cartographicToCartesian(e)})).finally((function(){i.flyTo({destination:c,complete:function(){e._complete.raiseEvent()},duration:e._flightDuration,endTransform:Matrix4.IDENTITY})}))}async function attemptGeocode(e,t,o){try{return{state:"fulfilled",value:await e.geocode(t,o),credits:e.credit}}catch(e){return{state:"rejected",reason:e}}}async function geocode(e,t,o){const s=e._searchText;if(hasOnlyWhitespace(s))return void e.showSuggestions();let i,n;for(e._isSearchInProgress=!0,e._wasGeocodeCancelled=!1,i=0;i<t.length;i++){if(e._wasGeocodeCancelled)return;if(n=await attemptGeocode(t[i],s,o),defined(n)&&"fulfilled"===n.state&&n.value.length>0)break}if(e._wasGeocodeCancelled)return;e._isSearchInProgress=!1,clearCredits(e);const r=n.value;if("fulfilled"===n.state&&defined(r)&&r.length>0){e._searchText=r[0].displayName,e.destinationFound(e,r[0].destination);const o=updateCredits(e,GeocoderService.getCreditsFromResult(r[0]));defined(o)||updateCredit(e,t[i].credit)}else e._searchText=`${s} (not found)`}function updateCredit(e,t){!defined(t)||e._scene.isDestroyed()||e._scene.frameState.creditDisplay.isDestroyed()||(e._scene.frameState.creditDisplay.addStaticCredit(t),e._previousCredits.push(t))}function updateCredits(e,t){return defined(t)&&t.forEach((t=>updateCredit(e,t))),t}function clearCredits(e){e._scene.isDestroyed()||e._scene.frameState.creditDisplay.isDestroyed()||e._previousCredits.forEach((t=>{e._scene.frameState.creditDisplay.removeStaticCredit(t)})),e._previousCredits.length=0}function adjustSuggestionsScroll(e,t){const o=getElement(e._viewContainer),s=o.getElementsByClassName("search-results")[0],i=o.getElementsByTagName("li")[t];if(0===t)return void(s.scrollTop=0);const n=i.offsetTop;n+i.clientHeight>s.clientHeight?s.scrollTop=n+i.clientHeight:n<s.scrollTop&&(s.scrollTop=n)}function cancelGeocode(e){e._isSearchInProgress&&(e._isSearchInProgress=!1,e._wasGeocodeCancelled=!0)}function hasOnlyWhitespace(e){return/^\s*$/.test(e)}function clearSuggestions(e){knockout.getObservable(e,"_suggestions").removeAll()}async function updateSearchSuggestions(e){if(!e.autoComplete)return;const t=e._searchText;if(clearSuggestions(e),clearCredits(e),!hasOnlyWhitespace(t))for(const o of e._geocoderServices){const s=await o.geocode(t,GeocodeType.AUTOCOMPLETE);if(e._suggestions=e._suggestions.concat(s),s.length>0){let t=!0;s.forEach((o=>{const s=GeocoderService.getCreditsFromResult(o);t=t&&!defined(s),updateCredits(e,s)})),t&&updateCredit(e,o.credit)}if(e._suggestions.length>=5)return}}Object.defineProperties(GeocoderViewModel.prototype,{complete:{get:function(){return this._complete}},scene:{get:function(){return this._scene}},search:{get:function(){return this._searchCommand}},selectedSuggestion:{get:function(){return this._selectedSuggestion}},suggestions:{get:function(){return this._suggestions}}}),GeocoderViewModel.prototype.destroy=function(){this._suggestionSubscription.dispose()},GeocoderViewModel.flyToDestination=flyToDestination,GeocoderViewModel._updateSearchSuggestions=updateSearchSuggestions,GeocoderViewModel._adjustSuggestionsScroll=adjustSuggestionsScroll,GeocoderViewModel.prototype.isDestroyed=function(){return!1},GeocoderViewModel.prototype.destroy=function(){return clearCredits(this),destroyObject(this)};export default GeocoderViewModel;